// YaSale - Street Food Kitchen SaaS - Complete Database Schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

// ============================================
// TENANCY & USERS
// ============================================

model Tenant {
  id String @id @default(cuid())
  name String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stripeCustomerId String? @unique
  stripeSubscriptionId String? @unique
  subscriptionPlan String @default("STARTER")
  subscriptionStatus String @default("TRIALING")
  trialEndsAt DateTime?
  maxStores Int @default(1)
  maxUsers Int @default(3)

  users User[]
  stores Store[]
  categories Category[]

  @@map("tenants")
}

enum UserRole {
  ADMIN
  MANAGER
  KITCHEN
  WAITER
  CASHIER
}

model User {
  id String @id @default(cuid())
  name String
  pin String
  role UserRole
  tenantId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stores UserStore[]
  orders Order[] @relation("WaiterOrders")
  checks Check[] @relation("WaiterChecks")

  @@unique([tenantId, pin])
  @@index([tenantId])
  @@map("users")
}

model UserStore {
  userId String
  storeId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@id([userId, storeId])
  @@index([userId])
  @@index([storeId])
  @@map("user_stores")
}

model Store {
  id String @id @default(cuid())
  name String
  tenantId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users UserStore[]
  products Product[]
  orders Order[]
  checks Check[]
  printerConfigs PrinterConfig[]

  @@index([tenantId])
  @@map("stores")
}

model Category {
  id String @id @default(cuid())
  name String
  tenantId String
  sortOrder Int @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products Product[]

  @@index([tenantId])
  @@map("categories")
}

model Product {
  id String @id @default(cuid())
  name String
  description String? @db.Text
  basePrice Decimal @db.Decimal(10, 2)
  categoryId String
  storeId String
  isActive Boolean @default(true)
  sortOrder Int @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  variantGroups VariantGroup[]
  modifierGroups ModifierGroup[]
  orderItems OrderItem[]

  @@index([categoryId])
  @@index([storeId])
  @@map("products")
}

model VariantGroup {
  id String @id @default(cuid())
  name String
  productId String
  isRequired Boolean @default(true)
  sortOrder Int @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  options VariantOption[]

  @@index([productId])
  @@map("variant_groups")
}

model VariantOption {
  id String @id @default(cuid())
  name String
  variantGroupId String
  priceModifier Decimal @default(0) @db.Decimal(10, 2)
  sortOrder Int @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  variantGroup VariantGroup @relation(fields: [variantGroupId], references: [id], onDelete: Cascade)

  @@index([variantGroupId])
  @@map("variant_options")
}

model ModifierGroup {
  id String @id @default(cuid())
  name String
  productId String
  sortOrder Int @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  options ModifierOption[]

  @@index([productId])
  @@map("modifier_groups")
}

enum ModifierType {
  ADD
  REMOVE
}

model ModifierOption {
  id String @id @default(cuid())
  name String
  modifierGroupId String
  type ModifierType @default(ADD)
  price Decimal @default(0) @db.Decimal(10, 2)
  sortOrder Int @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  modifierGroup ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
  orderItemMods OrderItemModifier[]

  @@index([modifierGroupId])
  @@map("modifier_options")
}

enum OrderType {
  DINE_IN
  TO_GO
}

enum OrderStatus {
  PENDING
  IN_PROGRESS
  READY
  COMPLETED
  CANCELLED
}

model Order {
  id String @id @default(cuid())
  number String
  type OrderType
  status OrderStatus @default(PENDING)
  tableNumber String?
  customerName String?
  notes String? @db.Text
  storeId String
  waiterId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  startedAt DateTime?
  readyAt DateTime?

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  waiter User @relation("WaiterOrders", fields: [waiterId], references: [id])
  items OrderItem[]
  checks CheckOrder[]

  @@unique([storeId, number])
  @@index([storeId])
  @@index([status])
  @@index([waiterId])
  @@map("orders")
}

model OrderItem {
  id String @id @default(cuid())
  orderId String
  productId String
  quantity Int
  unitPrice Decimal @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2)
  notes String? @db.Text
  selectedVariants Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
  modifiers OrderItemModifier[]

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model OrderItemModifier {
  id String @id @default(cuid())
  orderItemId String
  modifierId String
  type ModifierType
  price Decimal @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifier ModifierOption @relation(fields: [modifierId], references: [id])

  @@index([orderItemId])
  @@index([modifierId])
  @@map("order_item_modifiers")
}

enum CheckStatus {
  OPEN
  PAID
  CANCELLED
}

model Check {
  id String @id @default(cuid())
  number String
  status CheckStatus @default(OPEN)
  subtotal Decimal @db.Decimal(10, 2)
  tax Decimal @db.Decimal(10, 2)
  tip Decimal @default(0) @db.Decimal(10, 2)
  total Decimal @db.Decimal(10, 2)
  storeId String
  waiterId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  paidAt DateTime?

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  waiter User @relation("WaiterChecks", fields: [waiterId], references: [id])
  orders CheckOrder[]

  @@unique([storeId, number])
  @@index([storeId])
  @@index([status])
  @@index([waiterId])
  @@map("checks")
}

model CheckOrder {
  checkId String
  orderId String

  check Check @relation(fields: [checkId], references: [id], onDelete: Cascade)
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@id([checkId, orderId])
  @@index([checkId])
  @@index([orderId])
  @@map("check_orders")
}

model PrinterConfig {
  id String @id @default(cuid())
  name String
  ipAddress String
  port Int @default(9100)
  storeId String
  isActive Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  printJobs PrintJob[]

  @@index([storeId])
  @@map("printer_configs")
}

enum PrintJobStatus {
  QUEUED
  SENT
  FAILED
}

model PrintJob {
  id String @id @default(cuid())
  printerConfigId String
  orderId String
  status PrintJobStatus @default(QUEUED)
  attempts Int @default(0)
  errorMessage String? @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sentAt DateTime?

  printerConfig PrinterConfig @relation(fields: [printerConfigId], references: [id], onDelete: Cascade)

  @@index([printerConfigId])
  @@index([status])
  @@map("print_jobs")
}
